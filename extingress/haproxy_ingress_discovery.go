// SPDX-License-Identifier: MIT
// SPDX-FileCopyrightText: 2025 Steadybit GmbH

package extingress

import (
	"context"
	"fmt"
	"reflect"
	"time"

	"github.com/rs/zerolog/log"
	"github.com/steadybit/discovery-kit/go/discovery_kit_api"
	"github.com/steadybit/discovery-kit/go/discovery_kit_commons"
	"github.com/steadybit/discovery-kit/go/discovery_kit_sdk"
	"github.com/steadybit/extension-kit/extbuild"
	"github.com/steadybit/extension-kit/extutil"
	"github.com/steadybit/extension-kubernetes/v2/client"
	"github.com/steadybit/extension-kubernetes/v2/extcommon"
	"github.com/steadybit/extension-kubernetes/v2/extconfig"
	networkingv1 "k8s.io/api/networking/v1"
)

type ingressDiscovery struct {
	k8s *client.Client
}

var (
	_ discovery_kit_sdk.TargetDescriber = (*ingressDiscovery)(nil)
)

func NewIngressDiscovery(k8s *client.Client) discovery_kit_sdk.TargetDiscovery {
	discovery := &ingressDiscovery{
		k8s: k8s,
	}

	chRefresh := extcommon.TriggerOnKubernetesResourceChange(k8s,
		reflect.TypeOf(networkingv1.Ingress{}),
		reflect.TypeOf(networkingv1.IngressClass{}),
	)

	return discovery_kit_sdk.NewCachedTargetDiscovery(discovery,
		discovery_kit_sdk.WithRefreshTargetsNow(),
		discovery_kit_sdk.WithRefreshTargetsTrigger(context.Background(), chRefresh, time.Duration(extconfig.Config.DiscoveryRefreshThrottle)*time.Second),
	)
}

func (d *ingressDiscovery) Describe() discovery_kit_api.DiscoveryDescription {
	return discovery_kit_api.DiscoveryDescription{
		Id: HAProxyIngressTargetType,
		Discover: discovery_kit_api.DescribingEndpointReferenceWithCallInterval{
			CallInterval: extutil.Ptr("30s"),
		},
	}
}

func (d *ingressDiscovery) DescribeTarget() discovery_kit_api.TargetDescription {
	return discovery_kit_api.TargetDescription{
		Id:       HAProxyIngressTargetType,
		Label:    discovery_kit_api.PluralLabel{One: "HAProxy Ingress", Other: "HAProxy Ingresses"},
		Category: extutil.Ptr("Kubernetes"),
		Version:  extbuild.GetSemverVersionStringOrUnknown(),
		Icon:     extutil.Ptr("data:image/svg+xml,%3Csvg%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Cpath%20d%3D%22M13.3799%201.50488L13.374%202.24414L13.207%202.24219L13.5078%203.31445L13.9775%203.31152L14.5879%202.55469L14.5938%201.88184L15.333%201.8877L15.3271%202.62598L15.291%202.625L15.6826%203.27832L16.4629%203.06445L16.4658%202.69727L17.2051%202.70312L17.1992%203.44238L16.8916%203.43945L16.8008%204.44141L17.2754%204.43848L17.2764%204.63672L18.1436%204.1875L18.1465%203.81543L18.8857%203.82031L18.8809%204.55957L18.6611%204.55762L18.7383%205.28418L19.5342%205.40137L19.5361%205.22461L20.2754%205.22949L20.2705%205.96875L19.7891%205.96484L19.3369%206.77246H19.4912L19.4941%207.26367L20.6416%207.16699L20.6436%206.88574L21.3828%206.89062L21.3779%207.62988L20.9453%207.62695L20.6533%208.3125L21.458%208.76758L21.459%208.73828L22.1982%208.74316L22.1934%209.48242L21.4541%209.47754V9.43066L20.1543%2010.3027L20.1562%2010.5801L21.749%2010.9023L21.751%2010.6914L22.4902%2010.6963L22.4854%2011.4355L21.8184%2011.4307L21.2227%2012.0078L21.9033%2012.6641L22.5%2012.6689L22.4951%2013.4082L21.7559%2013.4033L21.7568%2013.1855L20.1494%2013.4883L20.1475%2013.7949L21.4277%2014.6523L21.4287%2014.6377L22.168%2014.6426L22.1621%2015.3818L21.4229%2015.377V15.2832L20.623%2015.7402L20.9521%2016.4912L21.3721%2016.4951L21.3672%2017.2344L20.6279%2017.2285L20.6299%2016.8965L19.5039%2016.7852L19.501%2017.2646L19.333%2017.2627L19.8193%2018.1621L20.2852%2018.166L20.2803%2018.9053L19.541%2018.9004L19.542%2018.6436L18.7188%2018.7637L18.6279%2019.5332L18.8955%2019.5352L18.8906%2020.2744L18.1514%2020.2695L18.1533%2019.8447L17.2871%2019.4004L17.2861%2019.6094L16.8018%2019.6055L16.8809%2020.6953L17.1885%2020.6934L17.1943%2021.4326L16.4551%2021.4375L16.4521%2021.0137L15.6895%2020.792L15.249%2021.5381L15.4033%2021.54L15.3965%2022.2793L14.6572%2022.2725L14.6631%2021.5967L13.9658%2020.7051L13.5352%2020.7021L13.2158%2021.8408L13.3789%2021.8398L13.3838%2022.5791L12.6445%2022.584L12.6406%2022.0518L11.9863%2021.5176L11.3633%2022.0205L11.3604%2022.5996L10.6211%2022.5947L10.626%2021.8555H10.7559L10.4473%2020.6992L10.0283%2020.7021L9.39062%2021.5176L9.38672%2022.2168L8.64746%2022.2119L8.65234%2021.4727H8.7041L8.31641%2020.8174L7.56738%2021.0449L7.56445%2021.4414L6.8252%2021.4365L6.83105%2020.6973L7.09668%2020.6982L7.18555%2019.5928L6.70508%2019.5967L6.70312%2019.4209L5.86523%2019.876L5.86328%2020.2939L5.12402%2020.2891L5.12891%2019.5498L5.33008%2019.5508L5.24512%2018.7803L4.47559%2018.6768L4.47461%2018.9043L3.73535%2018.8994L3.74023%2018.1602L4.16309%2018.1631L4.65625%2017.2607L4.48926%2017.2627L4.48535%2016.8018L3.34863%2016.9092L3.34668%2017.2236L2.60742%2017.2188L2.6123%2016.4795L3.02637%2016.4814L3.33496%2015.7656L2.60156%2015.3545V15.3809L1.8623%2015.376L1.86816%2014.6367L2.53711%2014.6406L3.8252%2013.7646L3.82324%2013.4668L2.24023%2013.1826L2.23926%2013.4082L1.5%2013.4033L1.50488%2012.6641L2.09082%2012.667L2.75195%2012.04L2.11621%2011.4443L1.5%2011.4395L1.50488%2010.7002L2.24414%2010.7061L2.24219%2010.8896L3.80957%2010.5869L3.81152%2010.2598L2.60156%209.45117V9.48145L1.8623%209.47656L1.86816%208.7373L2.60742%208.74219L2.60645%208.76855L3.35938%208.32617L3.05371%207.62695L2.61816%207.62402L2.62305%206.88477L3.3623%206.89062L3.36035%207.18359L4.47461%207.26855L4.47852%206.78418L4.62988%206.78516L4.17285%205.96582L3.73535%205.96387L3.74023%205.22461L4.47949%205.22949L4.47754%205.48047L5.25488%205.34277L5.35156%204.55469L5.125%204.55371L5.12988%203.81445L5.86914%203.81934L5.86523%204.26465L6.69141%204.66406L6.69336%204.44922L7.1748%204.45215L7.10352%203.42871L6.82227%203.43164L6.81738%202.69238L7.55664%202.68652L7.55859%203.07031L8.28906%203.27344L8.66895%202.6416H8.6377L8.64355%201.90234L9.38281%201.90723L9.37695%202.54883L10.0049%203.33301L10.4492%203.33691L10.7578%202.24414L10.623%202.24512L10.6172%201.50586L11.3564%201.50098L11.3604%202.1377L11.9385%202.57812L12.6357%202.01855L12.6406%201.5L13.3799%201.50488ZM10.6533%2020.6982L10.9629%2021.8574L11.2461%2021.8594L11.8291%2021.3887L10.9805%2020.6963L10.6533%2020.6982ZM12.1455%2021.3896L12.7012%2021.8438L13.0088%2021.8418L13.3291%2020.7002L13.001%2020.6982L12.1455%2021.3896ZM14.2256%2020.707L14.2197%2020.7061L14.8672%2021.5342L15.0176%2021.5361L15.4922%2020.7344L14.2275%2020.3662L14.2256%2020.707ZM8.5127%2020.7568L8.93652%2021.4736L9.16992%2021.4756L9.77344%2020.7031L9.76172%2020.7041L9.75879%2020.377L8.5127%2020.7568ZM11.0039%2019.793L11.0088%2020.4609L11.9873%2021.2607L12.9678%2020.4688L12.9727%2019.7803L11.999%2019.0254L11.0039%2019.793ZM7.38574%2019.5918L7.29688%2020.7002L7.57031%2020.7021L7.56836%2020.8359L8.21191%2020.6406L7.59082%2019.5898L7.38574%2019.5918ZM15.7949%2020.6152L16.4502%2020.8057V20.6982L16.6816%2020.6963L16.6006%2019.6045L16.3926%2019.6025L15.7949%2020.6152ZM7.94727%2018.7041L7.9541%2019.5879H7.82227L8.4082%2020.5801L9.75781%2020.1689L9.75293%2019.4453L10.1123%2019.4424L9.8623%2018.1328L8.88965%2018.127V18.0186L7.94727%2018.7041ZM15.0771%2018.1299L14.1387%2018.123L13.8789%2019.4551L14.2344%2019.458L14.2285%2020.1602L15.5967%2020.5576L16.1611%2019.6006H16.0273L16.0332%2018.6943L15.0771%2017.9971V18.1299ZM5.53125%2019.5518L5.86816%2019.5547L5.86719%2019.6465L6.70215%2019.1934L6.7002%2018.9766L5.44824%2018.8076L5.53125%2019.5518ZM17.29%2018.9707L17.2891%2019.1758L18.1553%2019.6211L18.1562%2019.5303L18.4277%2019.5312L18.5156%2018.7939L17.29%2018.9707ZM12.2422%2018.8369L13.0322%2019.4492L13.5752%2019.4531L13.834%2018.1211L13.2188%2018.1172V18.082L12.2422%2018.8369ZM10.748%2018.1396L10.166%2018.1348L10.416%2019.4404L10.9756%2019.4375L11.7539%2018.8359L10.748%2018.0566V18.1396ZM5.73828%2017.2539L5.27539%2017.2568L5.42578%2018.6045L6.69922%2018.7754L6.69629%2018.3379L7.11719%2018.334L6.97168%2016.9951L5.73535%2016.8613L5.73828%2017.2539ZM17.0264%2016.9824L16.8721%2018.3564L17.2949%2018.3604L17.292%2018.7695L18.5391%2018.5889L18.6973%2017.2588L18.2422%2017.2559L18.2441%2016.8438L17.0264%2016.9824ZM10.7588%2016.5586L10.751%2017.6807L11.998%2018.6475L13.2207%2017.7021L13.2285%2016.5537L12.7939%2016.0723L11.2031%2016.0605L10.7588%2016.5586ZM4.88379%2017.2598L4.38672%2018.165L4.47949%2018.166L4.47656%2018.4756L5.22266%2018.5771L5.0752%2017.2578L4.88379%2017.2598ZM18.7432%2018.5586L19.5439%2018.4414L19.5459%2018.1611H19.5908L19.1055%2017.2617L18.8975%2017.2598L18.7432%2018.5586ZM15.083%2017.2012L15.0801%2017.6289L16.0703%2018.3516L16.5723%2018.3545L16.7227%2017.0166L15.083%2017.2012ZM7.41797%2018.332L7.94531%2018.3291V18.335L8.89258%2017.6455L8.89551%2017.2031L7.27539%2017.0283L7.41797%2018.332ZM7.74805%2015.1602L7.06934%2015.1543L7.24219%2016.7236L8.89746%2016.9023L8.90234%2016.2783L9.43555%2016.2812L9.2793%2014.7676L7.75098%2014.6162L7.74805%2015.1602ZM14.668%2014.8223L14.5469%2016.2773L15.0898%2016.2812L15.085%2016.9004L16.7559%2016.7119L16.9307%2015.1514L16.2383%2015.1475L16.2412%2014.6973L14.668%2014.8223ZM3.24219%2016.4834L3.35156%2016.4844L3.34961%2016.708L4.48438%2016.6016L4.48242%2016.4082L3.50977%2015.8633L3.24219%2016.4834ZM19.5068%2016.377L19.5049%2016.5859L20.6309%2016.6973L20.6328%2016.4893H20.7334L20.4482%2015.8398L19.5068%2016.377ZM5.72949%2016.0225L5.7334%2016.5605L6.9375%2016.6904L6.76855%2015.1523L6.3457%2015.1494L5.72949%2016.0225ZM17.0605%2016.6777L18.2471%2016.543L18.25%2016.0303L17.6035%2015.1562L17.2305%2015.1533L17.0605%2016.6777ZM10.0371%2016.2852L10.2002%2016.2871L10.6934%2015.7354L10.6992%2014.9072L9.88574%2014.8271L10.0371%2016.2852ZM13.3174%2014.9287L13.3115%2015.7529L13.7812%2016.2715L13.9482%2016.2734L14.0635%2014.8701L13.3174%2014.9287ZM5.07715%2014.0996L4.26562%2014.1045L3.58887%2015.6787L4.48145%2016.1787L4.48047%2016.0039L5.38086%2015.9971L5.98242%2015.1465H5.88965L5.89648%2014.0928L5.0752%2013.834L5.07715%2014.0996ZM18.1035%2014.1582L18.0967%2015.1602L17.9775%2015.1592L18.6055%2016.0088L19.5098%2016.0156L19.5088%2016.1465L20.3682%2015.6553L19.6895%2014.1094L18.8965%2014.1045L18.8975%2013.8818L18.1035%2014.1582ZM2.60547%2014.834L2.60352%2015.127L3.41406%2015.5811L4.04785%2014.1064L3.82812%2014.1084L3.82715%2014.0029L2.60547%2014.834ZM20.1455%2014.1133L19.9082%2014.1113L20.542%2015.5557L21.4248%2015.0508L21.4258%2014.8916L20.1455%2014.0342V14.1133ZM13.29%2010.6201L10.6719%2010.6016L10.6777%209.75488L9.80859%209.85449L9.7207%2010.7627L10.6094%2010.7695L10.5918%2013.3779L9.73438%2013.3711L9.82324%2014.2217L10.7031%2014.3086L10.71%2013.4492L13.3281%2013.4678L13.3213%2014.3291L14.1143%2014.2666L14.1885%2013.3652L13.3799%2013.3604L13.3984%2010.752L14.1855%2010.7568L14.1094%209.84766L13.2959%209.75488L13.29%2010.6201ZM14.7178%2014.2197L16.2451%2014.0977L16.2471%2013.9121L15.6309%2013.375L14.7881%2013.3691L14.7178%2014.2197ZM7.75684%2013.7988L7.75586%2014.0176L9.21582%2014.1621L9.13281%2013.3672L8.25781%2013.3613L7.75684%2013.7988ZM18.002%2013.3105L18.1104%2013.3115L18.1055%2013.8418L18.8994%2013.5664L18.9053%2012.8555H18.9307L18.6094%2012.3643L18.002%2013.3105ZM5.03027%2012.8408H5.06836L5.07227%2013.5205L5.89844%2013.7793L5.90234%2013.2979L6.04004%2013.2988L5.39258%2012.2979L5.03027%2012.8408ZM5.57324%2012.0273L6.39746%2013.3008L7.40918%2013.3086L7.97656%2012.8125L7.9873%2011.3105L7.42188%2010.8184L6.38477%2010.8105L5.57324%2012.0273ZM16.0127%2011.2686L16.001%2012.9053L16.4531%2013.2998L17.6484%2013.3076L18.4307%2012.0898L17.6045%2010.8271L16.543%2010.8193L16.0127%2011.2686ZM20.1523%2013.0439L20.1504%2013.2861L21.7578%2012.9824L21.7598%2012.8018L21.0801%2012.1465L20.1523%2013.0439ZM2.24316%2012.7969L2.24121%2012.9805L3.82129%2013.2646L3.82031%2013.041L2.89648%2012.1758L2.24316%2012.7969ZM19.3613%2011.1904L18.7871%2012.0879L19.2891%2012.8574L20.0527%2012.8633L20.9365%2012.0078L20.084%2011.1855L19.3613%2011.1904ZM3.04102%2012.0381L3.90527%2012.8486L4.66895%2012.8428L5.21582%2012.0254L4.68164%2011.2002L3.92871%2011.1943L3.04102%2012.0381ZM2.24121%2011.0918L2.24023%2011.2871L2.89648%2011.9023L3.80664%2011.0371L3.80762%2010.791L2.24121%2011.0918ZM20.1592%2010.9824L21.0791%2011.8701L21.7471%2011.2236L21.748%2011.1055L20.1582%2010.7822L20.1592%2010.9824ZM18.1172%2010.8311L17.9639%2010.8291L18.6074%2011.8135L19.0039%2011.1934L18.9121%2011.1943L18.9072%2010.5322L18.1201%2010.3135L18.1172%2010.8311ZM5.05859%2010.5469L5.05469%2011.2031L5.03809%2011.2021L5.39648%2011.7549L6.02832%2010.8076H5.89941L5.90234%2010.3086L5.05859%2010.5469ZM14.7852%2010.7607L15.6797%2010.7666L16.2617%2010.2744L16.2637%2010.0918L14.7148%209.91602L14.7852%2010.7607ZM7.7627%2010.0889L7.76074%2010.3213L8.25586%2010.752L9.12109%2010.7588L9.20215%209.92383L7.7627%2010.0889ZM3.6123%208.4082L4.28711%209.94824L5.06348%209.9541L5.06055%2010.2363L5.9043%209.99805L5.91211%208.95898H5.98535L5.34668%208.03906L4.46973%208.0332V7.90137L3.6123%208.4082ZM19.5%208.03125L18.6201%208.03613L17.9775%208.98047L18.1299%208.98242L18.1221%2010.0039L18.9053%2010.2217L18.9033%209.93555L19.7471%209.92871L20.4004%208.39844L19.498%207.88867L19.5%208.03125ZM19.9648%209.92773L20.1523%209.92676V10.0645L21.4551%209.18945L21.457%208.99512L20.5752%208.49707L19.9648%209.92773ZM2.60449%209.00098L2.60352%209.21191L3.81348%2010.0205L3.81445%209.94531L4.06934%209.94629L3.44043%208.50977L2.60449%209.00098ZM15.0771%207.77051L14.5342%207.7666L14.6641%209.30957L16.2676%209.49121L16.2715%208.96973L16.9229%208.97363L16.7393%207.2998L15.0811%207.09277L15.0771%207.77051ZM7.23535%207.30859L7.06348%208.9668L7.77051%208.97266L7.7666%209.48535L9.26074%209.31543L9.41016%207.75098L8.88965%207.74805L8.89355%207.10645L7.23535%207.30859ZM9.86621%209.24609L10.6816%209.15332L10.6875%208.2959L10.208%207.75684L10.0098%207.75488L9.86621%209.24609ZM13.3066%208.25L13.2998%209.15332L14.0586%209.24023L13.9336%207.7627L13.7344%207.76074L13.3066%208.25ZM17.2236%208.97559L17.6191%208.97852L18.2598%208.03809L18.251%208.03906L18.2471%207.48828L17.0439%207.33789L17.2236%208.97559ZM5.73145%207.49023L5.72852%208.04199L5.71289%208.04102L6.35156%208.96191L6.76367%208.96484L6.93262%207.34473L5.73145%207.49023ZM3.35742%207.62988L3.27148%207.62891L3.53223%208.22461L4.47168%207.66992L4.47363%207.46777L3.3584%207.38281L3.35742%207.62988ZM19.4951%207.46289L19.4971%207.65918L20.4795%208.21387L20.7295%207.625H20.6387L20.6396%207.36621L19.4951%207.46289ZM10.7578%206.30176L10.75%207.46777L11.2197%207.99609L12.7256%208.00684L13.2207%207.44043L13.2285%206.31055L11.9854%205.36621L10.7578%206.30176ZM5.43457%205.5127L5.27539%206.78906L5.7373%206.79297L5.73438%207.18848L6.96387%207.04004L7.10254%205.7002L6.68555%205.69824L6.6875%205.29004L5.43457%205.5127ZM17.2842%205.69727L16.8633%205.7002L17.0107%207.0332L18.2441%207.18652L18.2422%206.78027L18.6963%206.77734L18.5576%205.45898L17.2803%205.27148L17.2842%205.69727ZM7.2666%207.00391L8.89551%206.80566L8.89844%206.38867L7.94238%205.70605L7.40137%205.70312L7.2666%207.00391ZM15.0859%206.35547L15.083%206.79199L16.7061%206.99512L16.5635%205.70215L16.0352%205.70605L16.0342%205.68848L15.0859%206.35547ZM4.47559%205.68164L4.47461%205.96875L4.40234%205.96777L4.86035%206.78613L5.0752%206.78809L5.22949%205.5498L4.47559%205.68164ZM18.8955%206.77539L19.1064%206.77441L19.5605%205.96387H19.5312L19.5332%205.60254L18.7598%205.48926L18.8955%206.77539ZM7.80762%204.45605L7.95215%204.45801L7.94629%205.3418L8.90137%206.02344L8.90234%205.89941L9.83301%205.90527L10.0986%204.58301L9.73535%204.58105L9.74023%203.88379L8.38184%203.50586L7.80762%204.45605ZM14.2021%203.89062L14.207%204.56934L13.8594%204.57129L14.127%205.91504L15.0898%205.92188L15.0889%205.9873L16.0322%205.32422L16.0264%204.44727L16.1514%204.44629L15.5898%203.50977L14.2021%203.89062ZM13.0205%204.57617L12.2324%205.17871L13.2305%205.93652L13.2314%205.90918L13.8203%205.91309L13.5547%204.57324L13.0205%204.57617ZM10.1367%205.90723L10.7607%205.91211L10.7598%205.92383L11.7383%205.17871L10.9619%204.58887L10.4023%204.58496L10.1367%205.90723ZM5.86426%204.55859L5.55273%204.55566L5.45996%205.30664L6.68848%205.08789L6.69043%204.88379L5.86426%204.48438V4.55859ZM17.2783%204.85938L17.2793%205.06934L18.5352%205.25488L18.4609%204.55664L18.1416%204.55469V4.41211L17.2783%204.85938ZM11.001%203.58398L10.9961%204.24121L11.9844%204.99121L12.9561%204.24902L12.9521%203.60059L11.9424%202.83105L11.001%203.58398ZM7.56152%203.42578L7.30273%203.42773L7.37402%204.45312L7.57617%204.45508L8.18262%203.4502L7.55957%203.27637L7.56152%203.42578ZM15.7891%203.45508L16.3818%204.44434L16.6016%204.44238L16.6914%203.4375L16.4609%203.43652L16.4619%203.26953L15.7891%203.45508ZM14.1982%203.35352L14.2002%203.68555L15.4844%203.33301L15.0586%202.62402L14.7871%202.62207L14.1982%203.35352ZM8.48828%203.3291L9.74121%203.67773L9.74414%203.33203H9.74805L9.19922%202.64453L8.90039%202.64258L8.48828%203.3291ZM12.1025%202.70312L12.9502%203.34863V3.31836L13.3008%203.31543L12.999%202.24121L12.6787%202.23926L12.1025%202.70312ZM10.9648%202.24219L10.6543%203.33789L10.9873%203.33984L11.7783%202.70703L11.167%202.24121L10.9648%202.24219Z%22%20fill%3D%22currentColor%22%2F%3E%0A%3C%2Fsvg%3E%0A"),
		Table: discovery_kit_api.Table{
			Columns: []discovery_kit_api.Column{
				{Attribute: "k8s.ingress"},
				{Attribute: "k8s.namespace"},
				{Attribute: "k8s.cluster-name"},
				{Attribute: "k8s.ingress.class"},
			},
			OrderBy: []discovery_kit_api.OrderBy{
				{
					Attribute: "k8s.ingress",
					Direction: "ASC",
				},
			},
		},
	}
}

func (d *ingressDiscovery) DiscoverTargets(_ context.Context) ([]discovery_kit_api.Target, error) {
	ingresses := d.k8s.Ingresses()

	haproxyClasses, hasDefaultClass := d.k8s.GetHAProxyIngressClasses()
	log.Debug().Msgf("Found HAProxy IngressClasses: %v, hasDefault: %v", haproxyClasses, hasDefaultClass)

	filteredIngresses := make([]*networkingv1.Ingress, 0, len(ingresses))
	for _, ingress := range ingresses {
		if client.IsExcludedFromDiscovery(ingress.ObjectMeta) {
			continue
		}

		ingressClassName := d.getIngressClassName(ingress)
		usesHAProxyClass := d.isUsingHAProxyClass(ingressClassName, haproxyClasses, hasDefaultClass)

		if usesHAProxyClass {
			filteredIngresses = append(filteredIngresses, ingress)
		}
	}

	targets := make([]discovery_kit_api.Target, len(filteredIngresses))

	for i, ingress := range filteredIngresses {
		targetName := fmt.Sprintf("%s/%s/%s", extconfig.Config.ClusterName, ingress.Namespace, ingress.Name)
		attributes := map[string][]string{
			"k8s.namespace":    {ingress.Namespace},
			"k8s.ingress":      {ingress.Name},
			"k8s.cluster-name": {extconfig.Config.ClusterName},
			"k8s.distribution": {d.k8s.Distribution},
		}

		ingressClassName := d.getIngressClassName(ingress)
		if ingressClassName != "" {
			attributes["k8s.ingress.class"] = []string{ingressClassName}
			controller := d.k8s.GetIngressControllerByClassName(ingressClassName)
			if controller != "" {
				attributes["k8s.ingress.controller"] = []string{controller}
			}
		}

		hosts := make([]string, 0)
		for _, rule := range ingress.Spec.Rules {
			if rule.Host != "" {
				hosts = append(hosts, rule.Host)
			}
		}
		if len(hosts) > 0 {
			attributes["k8s.ingress.hosts"] = hosts
		}

		extcommon.AddLabels(ingress.ObjectMeta.Labels, attributes, "k8s.ingress.label", "k8s.label")
		extcommon.AddNamespaceLabels(d.k8s, ingress.Namespace, attributes)

		targets[i] = discovery_kit_api.Target{
			Id:         targetName,
			TargetType: HAProxyIngressTargetType,
			Label:      ingress.Name,
			Attributes: attributes,
		}
	}

	return discovery_kit_commons.ApplyAttributeExcludes(targets, extconfig.Config.DiscoveryAttributesExcludesIngress), nil
}

func (d *ingressDiscovery) getIngressClassName(ingress *networkingv1.Ingress) string {
	if ingress.Spec.IngressClassName != nil {
		return *ingress.Spec.IngressClassName
	}
	if ingress.ObjectMeta.Annotations != nil {
		if classAnnotation, ok := ingress.ObjectMeta.Annotations["kubernetes.io/ingress.class"]; ok {
			return classAnnotation
		}
	}
	return ""
}

func (d *ingressDiscovery) isUsingHAProxyClass(className string, haproxyClasses []string, hasDefaultClass bool) bool {
	if className != "" {
		for _, haproxyClass := range haproxyClasses {
			if className == haproxyClass {
				return true
			}
		}
	} else if hasDefaultClass {
		return true
	}
	return false
}
